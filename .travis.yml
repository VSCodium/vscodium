matrix:
  include:
    - os: linux
      sudo: required
      env: BUILDARCH=x64
      dist: trusty
    - os: osx

language: node_js
node_js: "10"

before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"
  - . install_deps.sh
  - . get_repo.sh
  - . check_tags.sh

script:
  - ./build.sh

before_deploy:
  - ./sign_mac_app.sh
  - ./create_zip.sh
  - ./create_dmg.sh
  - ./sum.sh

deploy:
  - provider: releases
    skip_cleanup: true
    overwrite: true
    name: $LATEST_MS_TAG
    api_key: $GITHUB_TOKEN
    file_glob: true
    file:
      - ./*.sha256
      - ./*.zip
      - ./*.tar.gz
      - ./*.dmg
      - ./*.deb
      - ./*.rpm
      - ./*.AppImage
    on:
      all_branches: true
      condition: $SHOULD_BUILD = yes
  - provider: packagecloud
    skip_cleanup: true
    package_glob: "*.deb"
    repository: vscodium
    username: dimkr
    token:
      secure: dAq02jnJD+rW9nONe1fSWdOjwaSr0L1qzp2VTtSVFcITIfb+A9QEyaT/oA2IOTYLxhGuC3mF63Kb3y9uK3/k0xv1lcuLFK2bKWYERgqjbab1N5W8dObHly2HKt4N7Vea4y8307L/JICFEqSnopv1X8uPCqj2lu7c3usE+tnARE4hcJFDKmIDONEica1d+k0apDEZILCFb9CiGMTuYZr6LtK8WDDA8mvRC8X6yjo1O7wuI1JHdl060w/kUrRkRyv+1uErYDoQdpbOoz5cB1DuDIDZPb0FoVB834wAXHeToZXC9uXLaVb+mrBTvzeFfMci/2GC205SZ5IX35MIQQYBYQ2JwEPfjPy36lhJbxZwpFp7Nwj9ZRRPvmaS2sYrrm6OOYOeSKJc42awj0JQ+VReFdCt+9nT7af5KMwWXQuOdEDEnqjFU9fB1iwn0eN0J1q/wEFT/tPoCasQyzgecD5byfpSqTPkgSqqbGM7PSypQ3UcATvhy2ZyXs/GVPtcAV112B1Abb0w3BFhG2XkSB1cA4RcRlsbkafdoqHnr6eQDMxiOMm1RyegUyuUH3O9j4PK/OJRnriWl35Uy/J3yfZ8XPjjrey+bdqOniAMjUeD3PI9DvbxsTws/t8ycHC5FTjTk5YV2u94YngTNW42ZOym8Yxlb2v+9IBSIq4wLHWNAeg=
    dist: ubuntu/trusty
    on:
      all_branches: true
      condition: $SHOULD_BUILD = yes

after_deploy:
  - ./update_version.sh
